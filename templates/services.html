<!doctype html>
<html class="no-js" lang="">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Services - Jaylon Dental Clinic</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="icon" href="{{ url_for('static', filename='assets/images/clinic-logo2.png') }}" type="image/x-icon"/>

    <!-- CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.0/normalize.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">

    <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/cs-skin-elastic.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/style.css') }}">

    <!-- TABULATOR -->
    <link href="https://unpkg.com/tabulator-tables@6.3.1/dist/css/tabulator_bootstrap4.min.css" rel="stylesheet">

    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

    <style>
        .card-title { margin: 0; }
        .tabulator .tabulator-paginator label {
            margin-right: 5px;
        }
        .tabulator-row:hover {
            background-color: #f8f9fa;
        }
        
    </style>
</head>

<body>

<!-- LEFT PANEL -->
<aside id="left-panel" class="left-panel">
    <nav class="navbar navbar-expand-sm navbar-default">
        <div id="main-menu" class="main-menu collapse navbar-collapse">
            <ul class="nav navbar-nav">
                <li><a href="{{url_for('index')}}"><i class="menu-icon fa fa-laptop"></i>Dashboard</a></li>
                <li class="menu-title">Components</li>
                <li><a href="{{url_for('appointments')}}"><i class="menu-icon fa fa-check-square-o"></i>Appointments</a></li>
                <li><a href="{{url_for('payments')}}"><i class="menu-icon fa fa-credit-card"></i>Payments</a></li>
                <li class="active"><a href="{{url_for('services')}}"><i class="menu-icon fa fa-pencil-square-o"></i>Services</a></li>
                <li><a href="{{ url_for('calendar') }}"><i class="menu-icon fa fa-calendar"></i>Calendar</a></li>
            </ul>
        </div>
    </nav>
</aside>

<!-- RIGHT PANEL -->
<div id="right-panel" class="right-panel">


        <header id="header" class="header">
            <div class="top-left">
                <div class="navbar-header">
                    <a class="navbar-brand" href="./"><img src="{{url_for('static', filename='assets/images/clinic-logo.png')}}" alt="Logo"></a>
                    <a class="navbar-brand hidden" href="./"><img src="{{url_for('static', filename='assets/images/clinic-logo2.png')}}" alt="Logo"></a>
                    <a id="menuToggle" class="menutoggle"><i class="fa fa-bars"></i></a>
                </div>
            </div>
            <div class="top-right">
                <div class="header-menu">

                    <div class="user-area dropdown float-right">
                        <a href="#" class="dropdown-toggle active" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <img class="user-avatar rounded-circle" src="{{ url_for('static', filename='assets/images/default-profile.png') }}" alt="User Avatar">
                        </a>

                        <div class="user-menu dropdown-menu">
                            <a class="nav-link" href="{{url_for ('profile')}}"><i class="fa fa- user"></i>My Profile</a>
                            <a class="nav-link" href="{{ url_for('logout') }}"><i class="fa fa-power -off"></i>Logout</a>
                        </div>
                    </div>
                </div>
            </div>
        </header><!-- /header -->

<div class="breadcrumbs">
    <div class="breadcrumbs-inner">
        <div class="row m-0">
            <div class="col-sm-4">
                <h1>Services</h1>
            </div>
            <div class="col-sm-8">
                <div class="page-header float-right">
                    <div class="page-title">
                        <ol class="breadcrumb text-right">
                            <li><a href="#">Services</a></li>
                            <li class="active">Dental Services</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="content">
<div class="animated fadeIn">

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <strong class="card-title">Dental Services</strong>
        <button id="btnAddService" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#addServiceModal">
            + Add Service
        </button>
    </div>

    <div class="card-body">
        <!-- TABULATOR TABLE -->
        <div id="services-table"></div>
    </div>
</div>

</div>
</div>

<footer class="site-footer">
    <div class="footer-inner bg-white">
        <div class="row">
            <div class="col-sm-6">Copyright © 2025 Jaylon Dental Clinic</div>
        </div>
    </div>
</footer>

</div>

<!-- ================= MODALS ================= -->

<!-- ADD SERVICE MODAL -->
<div class="modal fade" id="addServiceModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <form id="addServiceForm" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Service</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Service Name</label>
                    <input type="text" name="name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Price (₱)</label>
                    <input type="number" name="price" class="form-control" min="0" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Down Payment (₱)</label>
                    <input type="number" name="downpayment" class="form-control" min="0" required>
                </div>
                <div class="form-group">
                    <label>Duration (minutes)</label>
                    <input type="number" name="duration" class="form-control" min="1" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Service</button>
            </div>
        </form>
    </div>
</div>

<!-- EDIT SERVICE MODAL -->
<div class="modal fade" id="editServiceModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <form id="editServiceForm" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Service</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit_id" name="id">
                <div class="form-group">
                    <label>Service Name</label>
                    <input type="text" id="edit_name" name="name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Price (₱)</label>
                    <input type="number" id="edit_price" name="price" class="form-control" min="0" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Down Payment (₱)</label>
                    <input type="number" id="edit_downpayment" name="downpayment" class="form-control" min="0" required>
                </div>
                <div class="form-group">
                    <label>Duration (minutes)</label>
                    <input type="number" id="edit_duration" name="duration" class="form-control" min="1" required>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-dismiss="modal" type="button">Cancel</button>
                <button class="btn btn-success" type="submit">Update</button>
            </div>
        </form>
    </div>
</div>

<!-- ================= SCRIPTS ================= -->
<script src="https://cdn.jsdelivr.net/npm/jquery@2.2.4/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.4/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js"></script>

<!-- TABULATOR -->
<script src="https://unpkg.com/tabulator-tables@6.3.1/dist/js/tabulator.min.js"></script>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
let servicesTable;

function showToastSuccess(title) {
    Swal.fire({ 
        icon: 'success', 
        title: title, 
        toast: true, 
        position: 'top-end', 
        showConfirmButton: false, 
        timer: 1500 
    });
}

function showToastError(title) {
    Swal.fire({ 
        icon: 'error', 
        title: title, 
        toast: true, 
        position: 'top-end', 
        showConfirmButton: false, 
        timer: 1800 
    });
}

function loadServices() {
    fetch('/get-services')
    .then(res => res.json())
    .then(data => {
        const tableData = data.map(service => ({
            id: service._id,
            name: service.name,
            price: service.price,
            downpayment: service.downpayment,
            duration: service.duration
        }));

        if (!servicesTable) {
            servicesTable = new Tabulator("#services-table", {
                data: tableData,
                layout: "fitColumns",
                responsiveLayout: "collapse",
                pagination: "local",
                paginationSize: 10,
                movableColumns: true,
                columns: [
                    { 
                        title: "Service", 
                        field: "name", 
                        headerFilter: "input" 
                    },
                    { 
                        title: "Price", 
                        field: "price", 
                        formatter: function(cell) {
                            return "₱" + parseFloat(cell.getValue()).toFixed(2);
                        }
                    },
                    { 
                        title: "Down Payment", 
                        field: "downpayment", 
                        formatter: function(cell) {
                            return "₱" + parseFloat(cell.getValue()).toFixed(2);
                        }
                    },
                    { 
                        title: "Duration", 
                        field: "duration", 
                        formatter: function(cell) {
                            return cell.getValue() + ' mins';
                        }
                    },
                    { 
                        title: "Actions", 
                        hozAlign: "center",
                        formatter: function(cell) {
                            const r = cell.getRow().getData();
                            return `
                                <button class="btn btn-warning btn-sm btn-edit"
                                    data-id="${r.id}"
                                    data-name="${r.name}"
                                    data-price="${r.price}"
                                    data-downpayment="${r.downpayment}"
                                    data-duration="${r.duration}">
                                    <i class="fa fa-pencil"></i> Edit
                                </button>
                                <button class="btn btn-danger btn-sm btn-delete"
                                    data-id="${r.id}">
                                    <i class="fa fa-trash"></i> Delete
                                </button>
                            `;
                        }
                    }
                ]
            });
        } else {
            servicesTable.setData(tableData);
        }
    })
    .catch(err => {
        console.error(err);
        showToastError('Failed to load services');
    });
}

// Edit button click handler
$(document).on("click", ".btn-edit", function() {
    const id = $(this).data("id");
    const name = $(this).data("name");
    const price = $(this).data("price");
    const downpayment = $(this).data("downpayment");
    const duration = $(this).data("duration");
    
    $("#edit_id").val(id);
    $("#edit_name").val(name);
    $("#edit_price").val(price);
    $("#edit_downpayment").val(downpayment);
    $("#edit_duration").val(duration);
    $("#editServiceModal").modal("show");
});

// Delete button click handler
$(document).on("click", ".btn-delete", function() {
    const id = $(this).data("id");
    
    Swal.fire({
        title: 'Delete this service?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Delete',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#d33'
    }).then((result) => {
        if (result.isConfirmed) {
            deleteService(id);
        }
    });
});

// Add service form submit
document.getElementById('addServiceForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const payload = {
        name: this.name.value.trim(),
        price: this.price.value,
        downpayment: this.downpayment.value,
        duration: this.duration.value
    };
    
    try {
        const res = await fetch('/add-service', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        const out = await res.json();
        
        if (out.success) {
            $('#addServiceModal').modal('hide');
            this.reset();
            showToastSuccess('Service added');
            setTimeout(loadServices, 300);
        } else {
            showToastError('Failed to add service');
        }
    } catch (err) {
        console.error(err);
        showToastError('Error adding service');
    }
});

// Edit service form submit
document.getElementById('editServiceForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const payload = {
        id: document.getElementById('edit_id').value,
        name: document.getElementById('edit_name').value.trim(),
        price: document.getElementById('edit_price').value,
        downpayment: document.getElementById('edit_downpayment').value,
        duration: document.getElementById('edit_duration').value
    };
    
    try {
        const res = await fetch('/update-service', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        const out = await res.json();
        
        if (out.success) {
            $('#editServiceModal').modal('hide');
            showToastSuccess('Service updated');
            loadServices();
        } else {
            showToastError('Could not update service');
        }
    } catch (err) {
        console.error(err);
        showToastError('Error updating service');
    }
});

// Delete service function
async function deleteService(id) {
    try {
        const res = await fetch(`/delete-service/${id}`, { method: 'DELETE' });
        const out = await res.json();
        
        if (out.success) {
            showToastSuccess('Service deleted');
            loadServices();
        } else {
            showToastError('Delete failed');
        }
    } catch (err) {
        console.error(err);
        showToastError('Error deleting service');
    }
}

// Clean up modal backdrop
$('#addServiceModal, #editServiceModal').on('hidden.bs.modal', function() {
    $('body').removeClass('modal-open');
    $('.modal-backdrop').remove();
});

// Load services on page load
$(document).ready(function() {
    loadServices();
});
</script>

</body>
</html>
