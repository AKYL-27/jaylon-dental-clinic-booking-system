<!doctype html>
<html class="no-js" lang="">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Payment Reports - Jaylon Dental Clinic</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="icon" href="{{ url_for('static', filename='assets/images/clinic-logo2.png') }}" type="image/x-icon"/>

    <!-- CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.0/normalize.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">

    <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/cs-skin-elastic.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/style.css') }}">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        body {
            background-color: #f5f5f5;
        }
        .content {
            background-color: #f5f5f5;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 30px;
        }
        .report-header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .detail-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
        }
        .filter-section {
            background: white;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 30px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .card {
            background: white;
            margin-bottom: 30px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: none;
            border-radius: 5px;
        }
        .charts-section {
            margin-bottom: 30px;
        }
        .card-header {
            background-color: rgba(255, 255, 255);
        }
    </style>
</head>

<body>

<!-- LEFT PANEL -->
<aside id="left-panel" class="left-panel">
    <nav class="navbar navbar-expand-sm navbar-default">
        <div id="main-menu" class="main-menu collapse navbar-collapse">
            <ul class="nav navbar-nav">
                <li><a href="{{url_for ('index')}}"><i class="menu-icon fa fa-laptop"></i>Dashboard</a></li>
                <li class="menu-title">Components</li>
                <li><a href="{{url_for ('appointments')}}"><i class="menu-icon fa fa-check-square-o"></i>Appointments</a></li>
                <li><a href="{{url_for ('payments')}}"><i class="menu-icon fa fa-credit-card"></i>Payments</a></li>
                <li><a href="{{url_for ('services')}}"><i class="menu-icon fa fa-pencil-square-o"></i>Services</a></li>
                <li><a href="{{url_for('patient_history')}}"><i class="menu-icon fa fa-history"></i>Patient History</a></li>
                <li class="active"><a href="{{ url_for('reports') }}"><i class="menu-icon fa fa-bar-chart"></i>Reports</a></li>
                <li><a href="{{ url_for('calendar') }}"><i class="menu-icon fa fa-calendar"></i>Calendar</a></li>
            </ul>
        </div>
    </nav>
</aside>

<!-- RIGHT PANEL -->
<div id="right-panel" class="right-panel">

    <header id="header" class="header">
        <div class="top-left">
            <div class="navbar-header">
                <a class="navbar-brand" href="./"><img src="{{url_for('static', filename='assets/images/clinic-logo.png')}}" alt="Logo"></a>
                <a class="navbar-brand hidden" href="./"><img src="{{url_for('static', filename='assets/images/clinic-logo2.png')}}" alt="Logo"></a>
                <a id="menuToggle" class="menutoggle"><i class="fa fa-bars"></i></a>
            </div>
        </div>
        <div class="top-right">
            <div class="header-menu">
                <div class="user-area dropdown float-right">
                    <a href="#" class="dropdown-toggle active" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <img class="user-avatar rounded-circle" src="{{ url_for('static', filename='assets/images/default-profile.png') }}" alt="User Avatar">
                    </a>
                    <div class="user-menu dropdown-menu">
                        <a class="nav-link" href="#"><i class="fa fa-user"></i>My Profile</a>
                        <a class="nav-link" href="#"><i class="fa fa-power-off"></i>Logout</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="breadcrumbs">
        <div class="breadcrumbs-inner">
            <div class="row m-0">
                <div class="col-sm-4">
                    <h1>Reports</h1>
                </div>
                <div class="col-sm-8">
                    <div class="page-header float-right">
                        <div class="page-title">
                            <ol class="breadcrumb text-right">
                                <li><a href="#">Reports</a></li>
                                <li class="active">Payment Analytics</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="content">
        <div class="animated fadeIn">

            <!-- Filter Section -->
            <div class="filter-section">
                <div class="row">
                    <div class="col-md-3">
                        <label>Status Filter</label>
                        <select id="statusFilter" class="form-control">
                            <option value="all">All Payments</option>
                            <option value="approved" selected>Approved Only</option>
                            <option value="pending">Pending Only</option>
                            <option value="declined">Declined Only</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label>Date From</label>
                        <input type="date" id="dateFrom" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label>Date To</label>
                        <input type="date" id="dateTo" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label>&nbsp;</label>
                        <button class="btn btn-primary btn-block" onclick="applyFilters()">
                            <i class="fa fa-filter"></i> Apply Filters
                        </button>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="charts-section">
                <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <strong>Payment Methods Distribution</strong>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="methodChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <strong>Revenue by Payment Method</strong>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="revenueChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>

            <!-- Detailed Breakdown Table -->
            <div class="card detail-table">
                <div class="card-header">
                    <strong>Detailed Payment Breakdown</strong>
                    <button class="btn btn-sm btn-success float-right" onclick="exportReport()">
                        <i class="fa fa-download"></i> Export PDF
                    </button>
                </div>
                <div class="card-body">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Payment Method</th>
                                <th>Number of Payments</th>
                                <th>Total Amount</th>
                                <th>Average Amount</th>
                                <th>Percentage</th>
                            </tr>
                        </thead>
                        <tbody id="breakdownTable">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <footer class="site-footer">
        <div class="footer-inner bg-white">
            <div class="row">
                <div class="col-sm-6">Copyright © 2025 Jaylon Dental Clinic</div>
            </div>
        </div>
    </footer>

</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/jquery@2.2.4/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.4/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js"></script>

<script>
// Payment data from Flask
const paymentsData = [
   {% for p in payments %}
   {
       id: "{{ p._id }}",
       fullname: "{{ p.fullname }}",
       method: "{{ p.payment_method }}",
       amount: {{ p.downpayment }},
       status: "{{ p.payment_status }}",
       date: "{{ p.appointment_date if p.appointment_date else '' }}"
   },
   {% endfor %}
];

let methodChart, revenueChart;
let currentStats = null;

function calculateStats(data) {
    const stats = {
        counter: { count: 0, total: 0 },
        gcash: { count: 0, total: 0 },
        paymaya: { count: 0, total: 0 }
    };

    data.forEach(payment => {
        const method = payment.method.toLowerCase();
        const amount = parseFloat(payment.amount) || 0;

        if (method.includes('counter')) {
            stats.counter.count++;
            stats.counter.total += amount;
        } else if (method.includes('gcash')) {
            stats.gcash.count++;
            stats.gcash.total += amount;
        } else if (method.includes('paymaya') || method.includes('maya')) {
            stats.paymaya.count++;
            stats.paymaya.total += amount;
        }
    });

    return stats;
}

function updateDisplay(stats) {
    currentStats = stats;
    const totalCount = stats.counter.count + stats.gcash.count + stats.paymaya.count;
    const grandTotal = stats.counter.total + stats.gcash.total + stats.paymaya.total;

    // Update breakdown table
    updateBreakdownTable(stats, grandTotal);

    // Update charts
    updateCharts(stats);
}

function updateBreakdownTable(stats, grandTotal) {
    const tbody = document.getElementById('breakdownTable');
    tbody.innerHTML = '';

    const methods = [
        { name: 'Counter', data: stats.counter, color: '#f5576c' },
        { name: 'GCash', data: stats.gcash, color: '#2f8cf7ff' },
        { name: 'PayMaya', data: stats.paymaya, color: '#00e774ff' }
    ];

    methods.forEach(method => {
        const avg = method.data.count > 0 ? method.data.total / method.data.count : 0;
        const percentage = grandTotal > 0 ? (method.data.total / grandTotal * 100) : 0;

        const row = `
            <tr>
                <td><span style="display:inline-block;width:12px;height:12px;background:${method.color};border-radius:2px;margin-right:8px;"></span>${method.name}</td>
                <td>${method.data.count}</td>
                <td>₱${method.data.total.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                <td>₱${avg.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                <td>${percentage.toFixed(1)}%</td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

function updateCharts(stats) {
    // Destroy existing charts
    if (methodChart) methodChart.destroy();
    if (revenueChart) revenueChart.destroy();

    // Method Distribution Chart (Pie)
    const methodCtx = document.getElementById('methodChart').getContext('2d');
    methodChart = new Chart(methodCtx, {
        type: 'doughnut',
        data: {
            labels: ['Counter', 'GCash', 'PayMaya'],
            datasets: [{
                data: [stats.counter.count, stats.gcash.count, stats.paymaya.count],
                backgroundColor: ['#f5576c', '#2f8cf7ff', '#00e774ff']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });

    // Revenue Chart (Bar)
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    revenueChart = new Chart(revenueCtx, {
        type: 'bar',
        data: {
            labels: ['Counter', 'GCash', 'PayMaya'],
            datasets: [{
                label: 'Total Revenue (₱)',
                data: [stats.counter.total, stats.gcash.total, stats.paymaya.total],
                backgroundColor: ['#f5576c', '#2f8cf7ff', '#00e774ff']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '₱' + value.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
                        }
                    }
                }
            }
        }
    });
}

function applyFilters() {
    const statusFilter = document.getElementById('statusFilter').value;
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;

    let filtered = paymentsData;

    // Filter by status
    if (statusFilter !== 'all') {
        filtered = filtered.filter(p => p.status.toLowerCase() === statusFilter);
    }

    // Filter by date range (if dates are provided)
    if (dateFrom) {
        filtered = filtered.filter(p => !p.date || p.date >= dateFrom);
    }
    if (dateTo) {
        filtered = filtered.filter(p => !p.date || p.date <= dateTo);
    }

    const stats = calculateStats(filtered);
    updateDisplay(stats);
}

async function exportReport() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    const statusFilter = document.getElementById('statusFilter').value;
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;
    
    // Add header
    doc.setFontSize(20);
    doc.setTextColor(40);
    doc.text('Jaylon Dental Clinic', 14, 20);
    
    doc.setFontSize(16);
    doc.text('Payment Report', 14, 30);
    
    // Add filter information
    doc.setFontSize(10);
    doc.setTextColor(100);
    doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 38);
    doc.text(`Status Filter: ${statusFilter.charAt(0).toUpperCase() + statusFilter.slice(1)}`, 14, 44);
    if (dateFrom || dateTo) {
        doc.text(`Date Range: ${dateFrom || 'Start'} to ${dateTo || 'End'}`, 14, 50);
    }
    
    let yPosition = dateFrom || dateTo ? 58 : 52;
    
    // Add summary statistics
    if (currentStats) {
        const grandTotal = currentStats.counter.total + currentStats.gcash.total + currentStats.paymaya.total;
        const totalCount = currentStats.counter.count + currentStats.gcash.count + currentStats.paymaya.count;
        
        doc.setFontSize(12);
        doc.setTextColor(40);
        doc.text('Summary', 14, yPosition);
        yPosition += 8;
        
        doc.setFontSize(10);
        doc.text(`Total Payments: ${totalCount}`, 14, yPosition);
        doc.text(`Grand Total: PHP ${grandTotal.toLocaleString('en-US', {minimumFractionDigits: 2})}`, 120, yPosition);
        yPosition += 10;
    }
    
    // Add breakdown table
    doc.setFontSize(12);
    doc.setTextColor(40);
    doc.text('Payment Method Breakdown', 14, yPosition);
    yPosition += 5;
    
    const tableData = [];
    if (currentStats) {
        const grandTotal = currentStats.counter.total + currentStats.gcash.total + currentStats.paymaya.total;
        const methods = [
            { name: 'Counter', data: currentStats.counter },
            { name: 'GCash', data: currentStats.gcash },
            { name: 'PayMaya', data: currentStats.paymaya }
        ];
        
        methods.forEach(method => {
            const avg = method.data.count > 0 ? method.data.total / method.data.count : 0;
            const percentage = grandTotal > 0 ? (method.data.total / grandTotal * 100) : 0;
            
            tableData.push([
                method.name,
                method.data.count.toString(),
                `PHP ${method.data.total.toLocaleString('en-US', {minimumFractionDigits: 2})}`,
                `PHP ${avg.toLocaleString('en-US', {minimumFractionDigits: 2})}`,
                `${percentage.toFixed(1)}%`
            ]);
        });
    }
    
    doc.autoTable({
        startY: yPosition,
        head: [['Payment Method', 'Count', 'Total Amount', 'Average', 'Percentage']],
        body: tableData,
        theme: 'striped',
        headStyles: { fillColor: [41, 128, 185] },
        styles: { fontSize: 9 },
        didParseCell: function(data) {
            // Replace ₱ with PHP in amount columns
            if (data.column.index === 2 || data.column.index === 3) {
                if (data.cell.text[0] && data.cell.text[0].includes('₱')) {
                    data.cell.text[0] = data.cell.text[0].replace('₱', 'PHP ');
                }
            }
        }
    });
    
    yPosition = doc.lastAutoTable.finalY + 15;
    
    // Add charts
    if (methodChart && revenueChart) {
        // Add method distribution chart
        const methodChartImg = methodChart.toBase64Image();
        doc.addPage();
        doc.setFontSize(14);
        doc.text('Payment Methods Distribution', 14, 20);
        doc.addImage(methodChartImg, 'PNG', 15, 30, 180, 100);
        
        // Add revenue chart
        const revenueChartImg = revenueChart.toBase64Image();
        doc.text('Revenue by Payment Method', 14, 145);
        doc.addImage(revenueChartImg, 'PNG', 15, 155, 180, 100);
    }
    
    // Add detailed transactions on new page
    let filtered = paymentsData;
    if (statusFilter !== 'all') {
        filtered = filtered.filter(p => p.status.toLowerCase() === statusFilter);
    }
    if (dateFrom) {
        filtered = filtered.filter(p => !p.date || p.date >= dateFrom);
    }
    if (dateTo) {
        filtered = filtered.filter(p => !p.date || p.date <= dateTo);
    }
    
    if (filtered.length > 0) {
        doc.addPage();
        doc.setFontSize(14);
        doc.text('Detailed Transactions', 14, 20);
        
        const transactionData = filtered.map(p => [
            p.method,
            p.fullname,
            `PHP ${parseFloat(p.amount).toLocaleString('en-US', {minimumFractionDigits: 2})}`,
            p.status,
            p.date && p.date.trim() !== '' ? p.date : new Date().toISOString().split('T')[0]
        ]);
        
        doc.autoTable({
            startY: 28,
            head: [['Method', 'Patient Name', 'Amount', 'Status', 'Date']],
            body: transactionData,
            theme: 'striped',
            headStyles: { fillColor: [41, 128, 185] },
            styles: { fontSize: 8 },
            columnStyles: {
                1: { cellWidth: 50 },
                2: { cellWidth: 30 }
            }
        });
    }
    
    // Save the PDF
    const filename = `payment_report_${new Date().toISOString().split('T')[0]}.pdf`;
    doc.save(filename);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Set status filter to approved by default
    document.getElementById('statusFilter').value = 'approved';
    applyFilters();
});
</script>

</body>
</html>
