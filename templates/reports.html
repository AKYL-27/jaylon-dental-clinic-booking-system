<!doctype html>
<html class="no-js" lang="">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Payment Reports - Jaylon Dental Clinic</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="icon" href="{{ url_for('static', filename='assets/images/clinic-logo2.png') }}" type="image/x-icon"/>

    <!-- CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.0/normalize.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">

    <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/cs-skin-elastic.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/style.css') }}">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        body {
            background-color: #f5f5f5;
        }
        .content {
            background-color: #f5f5f5;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 30px;
        }
        .report-header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .detail-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
        }
        .filter-section {
            background: white;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 30px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .card {
            background: white;
            margin-bottom: 30px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: none;
            border-radius: 5px;
        }
        .charts-section {
            margin-bottom: 30px;
        }
        .card-header {
            background-color: rgba(255, 255, 255);
        }
        
        /* Modal Styles */
        .modal-lg {
            max-width: 900px;
        }
        
        .patient-details-table {
            font-size: 0.9rem;
        }
        
        .patient-details-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        .badge-fully-paid {
            background-color: #28a745;
        }
        
        .badge-partial {
            background-color: #ffc107;
        }
        
        .badge-unpaid {
            background-color: #dc3545;
        }
        
        .details-btn {
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
        }
    </style>
</head>

<body>

<!-- LEFT PANEL -->
<aside id="left-panel" class="left-panel">
    <nav class="navbar navbar-expand-sm navbar-default">
        <div id="main-menu" class="main-menu collapse navbar-collapse">
            <ul class="nav navbar-nav">
                <li><a href="{{url_for ('index')}}"><i class="menu-icon fa fa-laptop"></i>Dashboard</a></li>
                <li class="menu-title">Components</li>
                <li><a href="{{url_for ('appointments')}}"><i class="menu-icon fa fa-check-square-o"></i>Appointments</a></li>
                <li><a href="{{url_for ('payments')}}"><i class="menu-icon fa fa-credit-card"></i>Payments</a></li>
                <li><a href="{{url_for ('services')}}"><i class="menu-icon fa fa-pencil-square-o"></i>Services</a></li>
                <li><a href="{{url_for('patient_history')}}"><i class="menu-icon fa fa-history"></i>Patient History</a></li>
                <li class="active"><a href="{{ url_for('reports') }}"><i class="menu-icon fa fa-bar-chart"></i>Reports</a></li>
                <li><a href="{{ url_for('calendar') }}"><i class="menu-icon fa fa-calendar"></i>Calendar</a></li>
            </ul>
        </div>
    </nav>
</aside>

<!-- RIGHT PANEL -->
<div id="right-panel" class="right-panel">

    <header id="header" class="header">
        <div class="top-left">
            <div class="navbar-header">
                <a class="navbar-brand" href="./"><img src="{{url_for('static', filename='assets/images/clinic-logo.png')}}" alt="Logo"></a>
                <a class="navbar-brand hidden" href="./"><img src="{{url_for('static', filename='assets/images/clinic-logo2.png')}}" alt="Logo"></a>
                <a id="menuToggle" class="menutoggle"><i class="fa fa-bars"></i></a>
            </div>
        </div>
        <div class="top-right">
            <div class="header-menu">
                <div class="user-area dropdown float-right">
                    <a href="#" class="dropdown-toggle active" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <img class="user-avatar rounded-circle" src="{{ url_for('static', filename='assets/images/default-profile.png') }}" alt="User Avatar">
                    </a>
                    <div class="user-menu dropdown-menu">
                        <a class="nav-link" href="#"><i class="fa fa-user"></i>My Profile</a>
                        <a class="nav-link" href="#"><i class="fa fa-power-off"></i>Logout</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="breadcrumbs">
        <div class="breadcrumbs-inner">
            <div class="row m-0">
                <div class="col-sm-4">
                    <h1>Reports</h1>
                </div>
                <div class="col-sm-8">
                    <div class="page-header float-right">
                        <div class="page-title">
                            <ol class="breadcrumb text-right">
                                <li><a href="#">Reports</a></li>
                                <li class="active">Payment Analytics</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="content">
        <div class="animated fadeIn">

            <!-- Filter Section -->
            <div class="filter-section">
                <div class="row">
                    <div class="col-md-3">
                        <label>Status Filter</label>
                        <select id="statusFilter" class="form-control">
                            <option value="all">All Payments</option>
                            <option value="approved" selected>Approved Only</option>
                            <option value="pending">Pending Only</option>
                            <option value="declined">Declined Only</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label>Date From</label>
                        <input type="date" id="dateFrom" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label>Date To</label>
                        <input type="date" id="dateTo" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label>&nbsp;</label>
                        <button class="btn btn-primary btn-block" onclick="applyFilters()">
                            <i class="fa fa-filter"></i> Apply Filters
                        </button>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="charts-section">
                <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <strong>Payment Methods Distribution</strong>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="methodChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <strong>Revenue by Payment Method</strong>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="revenueChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>

            <!-- Detailed Breakdown Table -->
            <div class="card detail-table">
                <div class="card-header">
                    <strong>Detailed Payment Breakdown</strong>
                    <button class="btn btn-sm btn-success float-right" onclick="exportReport()">
                        <i class="fa fa-download"></i> Export PDF
                    </button>
                </div>
                <div class="card-body">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Payment Method</th>
                                <th>Number of Payments</th>
                                <th>Total Amount</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="breakdownTable">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <footer class="site-footer">
        <div class="footer-inner bg-white">
            <div class="row">
                <div class="col-sm-6">Copyright © 2025 Jaylon Dental Clinic</div>
            </div>
        </div>
    </footer>

</div>

<!-- Patient Details Modal -->
<div class="modal fade" id="patientDetailsModal" tabindex="-1" role="dialog" aria-labelledby="patientDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="patientDetailsModalLabel">Patient Payment Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-bordered patient-details-table">
                        <thead>
                            <tr>
                                <th>Patient Name</th>
                                <th>Down Payment</th>
                                <th>Remaining Balance</th>
                                <th>Payment Status</th>
                            </tr>
                        </thead>
                        <tbody id="patientDetailsTableBody">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/jquery@2.2.4/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.4/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js"></script>

<script>
// Payment data from Flask - WITH DEBUGGING
const paymentsData = [
   {% for p in payments %}
   {
       id: "{{ p._id }}",
       fullname: "{{ p.fullname }}",
       method: "{{ p.payment_method }}",
       amount: parseFloat("{{ p.downpayment }}") || 0,
       servicePrice: parseFloat("{{ p.service_price }}") || 0,
       status: "{{ p.payment_status }}",
       paymentStatus: "{{ p.payment_status if p.payment_status else 'Pending' }}"
   },
   {% endfor %}
];

// DEBUG: Log the first few payments to check data
console.log("=== PAYMENT DATA DEBUG ===");
console.log("Total payments:", paymentsData.length);
if (paymentsData.length > 0) {
    console.log("First payment:", paymentsData[0]);
    console.log("Service Price:", paymentsData[0].servicePrice);
    console.log("Down Payment:", paymentsData[0].amount);
    console.log("Remaining:", paymentsData[0].servicePrice - paymentsData[0].amount);
}
console.log("=========================");

let methodChart, revenueChart;
let currentStats = null;
let currentFilteredData = [];

function calculateStats(data) {
    const stats = {
        counter: { count: 0, total: 0, payments: [] },
        gcash: { count: 0, total: 0, payments: [] },
        paymaya: { count: 0, total: 0, payments: [] }
    };

    data.forEach(payment => {
        const method = payment.method.toLowerCase();
        const amount = parseFloat(payment.amount) || 0;

        if (method.includes('counter')) {
            stats.counter.count++;
            stats.counter.total += amount;
            stats.counter.payments.push(payment);
        } else if (method.includes('gcash')) {
            stats.gcash.count++;
            stats.gcash.total += amount;
            stats.gcash.payments.push(payment);
        } else if (method.includes('paymaya') || method.includes('maya')) {
            stats.paymaya.count++;
            stats.paymaya.total += amount;
            stats.paymaya.payments.push(payment);
        }
    });

    return stats;
}

function updateDisplay(stats) {
    currentStats = stats;
    const totalCount = stats.counter.count + stats.gcash.count + stats.paymaya.count;
    const grandTotal = stats.counter.total + stats.gcash.total + stats.paymaya.total;

    // Update breakdown table
    updateBreakdownTable(stats, grandTotal);

    // Update charts
    updateCharts(stats);
}

function updateBreakdownTable(stats, grandTotal) {
    const tbody = document.getElementById('breakdownTable');
    tbody.innerHTML = '';

    const methods = [
        { name: 'Counter', data: stats.counter, color: '#f5576c' },
        { name: 'GCash', data: stats.gcash, color: '#2f8cf7ff' },
        { name: 'PayMaya', data: stats.paymaya, color: '#00e774ff' }
    ];

    methods.forEach(method => {
        const row = `
            <tr>
                <td><span style="display:inline-block;width:12px;height:12px;background:${method.color};border-radius:2px;margin-right:8px;"></span>${method.name}</td>
                <td>${method.data.count}</td>
                <td>₱${method.data.total.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                <td>
                    <button class="btn btn-sm btn-info details-btn" onclick="showPatientDetails('${method.name.toLowerCase()}')">
                        <i class="fa fa-eye"></i> More Details
                    </button>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

function showPatientDetails(methodName) {
    let payments = [];
    
    if (methodName === 'counter') {
        payments = currentStats.counter.payments;
    } else if (methodName === 'gcash') {
        payments = currentStats.gcash.payments;
    } else if (methodName === 'paymaya') {
        payments = currentStats.paymaya.payments;
    }
    
    console.log(`=== MODAL DEBUG for ${methodName} ===`);
    console.log("Payments to display:", payments.length);
    if (payments.length > 0) {
        console.log("First payment details:", {
            name: payments[0].fullname,
            servicePrice: payments[0].servicePrice,
            downPayment: payments[0].amount,
            calculated_remaining: payments[0].servicePrice - payments[0].amount
        });
    }
    
    // Update modal title
    const modalTitle = document.getElementById('patientDetailsModalLabel');
    modalTitle.textContent = `Patient Payment Details - ${methodName.charAt(0).toUpperCase() + methodName.slice(1)}`;
    
    // Populate table
    const tbody = document.getElementById('patientDetailsTableBody');
    tbody.innerHTML = '';
    
    if (payments.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">No payments found for this method</td></tr>';
    } else {
        payments.forEach(payment => {
            // Parse values explicitly
            const servicePrice = parseFloat(payment.servicePrice) || 0;
            const downPayment = parseFloat(payment.amount) || 0;
            
            // Calculate remaining balance: price - downpayment
            const remainingBalance = servicePrice - downPayment;
            
            console.log(`Patient: ${payment.fullname}`, {
                servicePrice: servicePrice,
                downPayment: downPayment,
                remainingBalance: remainingBalance
            });
            
            // Determine payment status badge
            let statusBadge = '';
            let statusClass = '';
            
            if (remainingBalance <= 0) {
                statusBadge = 'Fully Paid';
                statusClass = 'badge-fully-paid';
            } else if (downPayment > 0 && remainingBalance > 0) {
                statusBadge = 'Partial Payment';
                statusClass = 'badge-partial';
            } else {
                statusBadge = 'Unpaid';
                statusClass = 'badge-unpaid';
            }
            
            const row = `
                <tr>
                    <td>${payment.fullname}</td>
                    <td>₱${downPayment.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td>₱${remainingBalance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td><span class="badge ${statusClass}">${statusBadge}</span></td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }
    
    // Show modal
    $('#patientDetailsModal').modal('show');
}

function updateCharts(stats) {
    // Destroy existing charts
    if (methodChart) methodChart.destroy();
    if (revenueChart) revenueChart.destroy();

    // Method Distribution Chart (Pie)
    const methodCtx = document.getElementById('methodChart').getContext('2d');
    methodChart = new Chart(methodCtx, {
        type: 'doughnut',
        data: {
            labels: ['Counter', 'GCash', 'PayMaya'],
            datasets: [{
                data: [stats.counter.count, stats.gcash.count, stats.paymaya.count],
                backgroundColor: ['#f5576c', '#2f8cf7ff', '#00e774ff']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });

    // Revenue Chart (Bar)
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    revenueChart = new Chart(revenueCtx, {
        type: 'bar',
        data: {
            labels: ['Counter', 'GCash', 'PayMaya'],
            datasets: [{
                label: 'Total Revenue (₱)',
                data: [stats.counter.total, stats.gcash.total, stats.paymaya.total],
                backgroundColor: ['#f5576c', '#2f8cf7ff', '#00e774ff']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '₱' + value.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
                        }
                    }
                }
            }
        }
    });
}

function applyFilters() {
    const statusFilter = document.getElementById('statusFilter').value;
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;

    let filtered = paymentsData;

    // Filter by status
    if (statusFilter !== 'all') {
        filtered = filtered.filter(p => p.status.toLowerCase() === statusFilter);
    }

    // Filter by date range (if dates are provided)
    if (dateFrom) {
        filtered = filtered.filter(p => !p.date || p.date >= dateFrom);
    }
    if (dateTo) {
        filtered = filtered.filter(p => !p.date || p.date <= dateTo);
    }

    currentFilteredData = filtered;
    const stats = calculateStats(filtered);
    updateDisplay(stats);
}

async function exportReport() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    const statusFilter = document.getElementById('statusFilter').value;
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;
    
    // Add header
    doc.setFontSize(20);
    doc.setTextColor(40);
    doc.text('Jaylon Dental Clinic', 14, 20);
    
    doc.setFontSize(16);
    doc.text('Payment Report', 14, 30);
    
    // Add filter information
    doc.setFontSize(10);
    doc.setTextColor(100);
    doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 38);
    doc.text(`Status Filter: ${statusFilter.charAt(0).toUpperCase() + statusFilter.slice(1)}`, 14, 44);
    if (dateFrom || dateTo) {
        doc.text(`Date Range: ${dateFrom || 'Start'} to ${dateTo || 'End'}`, 14, 50);
    }
    
    let yPosition = dateFrom || dateTo ? 58 : 52;
    
    // Add summary statistics
    if (currentStats) {
        const grandTotal = currentStats.counter.total + currentStats.gcash.total + currentStats.paymaya.total;
        const totalCount = currentStats.counter.count + currentStats.gcash.count + currentStats.paymaya.count;
        
        doc.setFontSize(12);
        doc.setTextColor(40);
        doc.text('Summary', 14, yPosition);
        yPosition += 8;
        
        doc.setFontSize(10);
        doc.text(`Total Payments: ${totalCount}`, 14, yPosition);
        doc.text(`Grand Total: PHP ${grandTotal.toLocaleString('en-US', {minimumFractionDigits: 2})}`, 120, yPosition);
        yPosition += 10;
    }
    
    // Add breakdown table
    doc.setFontSize(12);
    doc.setTextColor(40);
    doc.text('Payment Method Breakdown', 14, yPosition);
    yPosition += 5;
    
    const tableData = [];
    if (currentStats) {
        const methods = [
            { name: 'Counter', data: currentStats.counter },
            { name: 'GCash', data: currentStats.gcash },
            { name: 'PayMaya', data: currentStats.paymaya }
        ];
        
        methods.forEach(method => {
            tableData.push([
                method.name,
                method.data.count.toString(),
                `PHP ${method.data.total.toLocaleString('en-US', {minimumFractionDigits: 2})}`
            ]);
        });
    }
    
    doc.autoTable({
        startY: yPosition,
        head: [['Payment Method', 'Count', 'Total Amount']],
        body: tableData,
        theme: 'striped',
        headStyles: { fillColor: [41, 128, 185] },
        styles: { fontSize: 9 }
    });
    
    yPosition = doc.lastAutoTable.finalY + 15;
    
    // Add charts
    if (methodChart && revenueChart) {
        // Add method distribution chart
        const methodChartImg = methodChart.toBase64Image();
        doc.addPage();
        doc.setFontSize(14);
        doc.text('Payment Methods Distribution', 14, 20);
        doc.addImage(methodChartImg, 'PNG', 15, 30, 180, 100);
        
        // Add revenue chart
        const revenueChartImg = revenueChart.toBase64Image();
        doc.text('Revenue by Payment Method', 14, 145);
        doc.addImage(revenueChartImg, 'PNG', 15, 155, 180, 100);
    }
    
    // Add detailed patient transactions for each payment method
    if (currentStats) {
        const methods = [
            { name: 'Counter', data: currentStats.counter },
            { name: 'GCash', data: currentStats.gcash },
            { name: 'PayMaya', data: currentStats.paymaya }
        ];
        
        methods.forEach(method => {
            if (method.data.payments.length > 0) {
                doc.addPage();
                doc.setFontSize(14);
                doc.text(`${method.name} - Patient Details`, 14, 20);
                
                const patientData = method.data.payments.map(p => {
                    const servicePrice = parseFloat(p.servicePrice) || 0;
                    const downPayment = parseFloat(p.amount) || 0;
                    const remainingBalance = servicePrice - downPayment;
                    let status = '';
                    
                    if (remainingBalance <= 0) {
                        status = 'Fully Paid';
                    } else if (downPayment > 0 && remainingBalance > 0) {
                        status = 'Partial Payment';
                    } else {
                        status = 'Unpaid';
                    }
                    
                    return [
                        p.fullname,
                        `PHP ${downPayment.toLocaleString('en-US', {minimumFractionDigits: 2})}`,
                        `PHP ${remainingBalance.toLocaleString('en-US', {minimumFractionDigits: 2})}`,
                        status,
                    ];
                });
                
                doc.autoTable({
                    startY: 28,
                    head: [['Patient Name', 'Down Payment', 'Remaining Balance', 'Status']],
                    body: patientData,
                    theme: 'striped',
                    headStyles: { fillColor: [41, 128, 185] },
                    styles: { fontSize: 8 },
                    columnStyles: {
                        0: { cellWidth: 50 },
                        1: { cellWidth: 35 },
                        2: { cellWidth: 35 },
                        3: { cellWidth: 35 },
                        4: { cellWidth: 30 }
                    }
                });
            }
        });
    }
    
    // Save the PDF
    const filename = `payment_report_${new Date().toISOString().split('T')[0]}.pdf`;
    doc.save(filename);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Set status filter to approved by default
    document.getElementById('statusFilter').value = 'approved';
    applyFilters();
});
</script>

</body>
</html>
