<!doctype html>
<html class="no-js" lang="">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Appointments - Jaylon Dental Clinic</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="icon" href="{{ url_for('static', filename='assets/images/clinic-logo2.png') }}" type="image/x-icon"/>

    <!-- CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.0/normalize.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">

    <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/cs-skin-elastic.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/style.css') }}">

    <!-- TABULATOR -->
    <link href="https://unpkg.com/tabulator-tables@6.3.1/dist/css/tabulator_bootstrap4.min.css" rel="stylesheet">

        <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

    <style>
        .tabulator-row:hover {
            background-color: #f8f9fa;
        }
        
        /* Custom styling for empty table message */
        .tabulator-placeholder {
            padding: 40px 20px !important;
            text-align: center;
            font-size: 16px;
            color: #6c757d;
        }
        
        .tabulator-placeholder i {
            font-size: 48px;
            color: #dee2e6;
            display: block;
            margin-bottom: 15px;
        }
        
        /* ============================================
           SPACING ADJUSTMENTS - MODIFY THESE VALUES
           ============================================ */
        
        /* Action buttons container */
        .action-buttons {
            white-space: nowrap;
            display: flex;
            gap: 6px;  /* ADJUST: Space between buttons (try: 4px, 6px, 8px, 10px) */
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            padding: 4px;  /* ADJUST: Padding inside the container (try: 2px, 4px, 6px) */
        }
        
        /* Individual button spacing and size */
        .action-buttons .btn {
            margin: 2px;  /* ADJUST: Extra margin around each button (try: 1px, 2px, 3px) */
        }
        
        /* Button padding (affects button size) */
        .btn-action {
            padding: 5px 10px;  /* ADJUST: Vertical and horizontal padding (try: 4px 8px, 5px 10px, 6px 12px) */
            font-size: 0.875rem;  /* ADJUST: Font size (try: 0.8rem, 0.875rem, 0.9rem) */
            line-height: 1.2;
            min-width: 32px;  /* ADJUST: Minimum button width (try: 28px, 32px, 36px) */
        }
        
        /* Row height */
        .tabulator .tabulator-row {
            min-height: 45px;  /* ADJUST: Row height (try: 40px, 45px, 50px) */
        }
        
        /* Cell padding */
        .tabulator .tabulator-cell {
            padding: 10px 15px;  /* More breathing room */  /* ADJUST: Cell padding (try: 6px, 8px, 10px) */
        }
    </style>
</head>

<body>

<!-- LEFT PANEL -->
<aside id="left-panel" class="left-panel">
    <nav class="navbar navbar-expand-sm navbar-default">
        <div id="main-menu" class="main-menu collapse navbar-collapse">
            <ul class="nav navbar-nav">
                <li><a href="{{url_for('index')}}"><i class="menu-icon fa fa-laptop"></i>Dashboard</a></li>
                <li class="menu-title">Components</li>
                <li class="active"><a href="{{url_for('appointments')}}"><i class="menu-icon fa fa-check-square-o"></i>Appointments</a></li>
                <li><a href="{{url_for('payments')}}"><i class="menu-icon fa fa-credit-card"></i>Payments</a></li>
                <li><a href="{{url_for('services')}}"><i class="menu-icon fa fa-pencil-square-o"></i>Services</a></li>
                <li><a href="{{ url_for('calendar') }}"><i class="menu-icon fa fa-calendar"></i>Calendar</a></li>
            </ul>
        </div>
    </nav>
</aside>

<!-- RIGHT PANEL -->
<div id="right-panel" class="right-panel">

        <header id="header" class="header">
            <div class="top-left">
                <div class="navbar-header">
                    <a class="navbar-brand" href="./"><img src="{{url_for('static', filename='assets/images/clinic-logo.png')}}" alt="Logo"></a>
                    <a class="navbar-brand hidden" href="./"><img src="{{url_for('static', filename='assets/images/clinic-logo2.png')}}" alt="Logo"></a>
                    <a id="menuToggle" class="menutoggle"><i class="fa fa-bars"></i></a>
                </div>
            </div>
            <div class="top-right">
                <div class="header-menu">

                    <div class="user-area dropdown float-right">
                        <a href="#" class="dropdown-toggle active" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <img class="user-avatar rounded-circle" src="{{ url_for('static', filename='assets/images/default-profile.png') }}" alt="User Avatar">
                        </a>

                        <div class="user-menu dropdown-menu">
                            <a class="nav-link" href="{{url_for ('profile')}}"><i class="fa fa- user"></i>My Profile</a>
                            <a class="nav-link" href="{{ url_for('logout') }}"><i class="fa fa-power -off"></i>Logout</a>
                        </div>
                    </div>
                </div>
            </div>
        </header><!-- /header -->

<div class="breadcrumbs">
    <div class="breadcrumbs-inner">
        <div class="row m-0">
            <div class="col-sm-4">
                <h1>Appointments</h1>
            </div>
            <div class="col-sm-8">
                <div class="page-header float-right">
                    <div class="page-title">
                        <ol class="breadcrumb text-right">
                            <li><a href="#">Appointments</a></li>
                            <li class="active">Appointments List</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="content">
<div class="animated fadeIn">

<div class="card">
    <div class="card-header">
        <strong class="card-title">Appointments List</strong>
    </div>

    <div class="card-body">
        <!-- TABULATOR TABLE -->
        <div id="appointments-table"></div>
    </div>
</div>

</div>
</div>

<footer class="site-footer">
    <div class="footer-inner bg-white">
        <div class="row">
            <div class="col-sm-6">Copyright ¬© 2025 Jaylon Dental Clinic</div>
        </div>
    </div>
</footer>

</div>

<!-- ================= MODALS ================= -->

<!-- RESCHEDULE -->
<div class="modal fade" id="rescheduleModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="rescheduleForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">üîÅ Reschedule Appointment</h5>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="appt_id" id="rescheduleApptId">
        <div class="form-group">
          <label>New Date</label>
          <input type="date" name="date" id="rescheduleDate" class="form-control" required>
        </div>
        <div class="form-group">
          <label>New Time</label>
          <input type="time" name="time" id="rescheduleTime" class="form-control" required>
        </div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Save</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
      </div>
    </form>
  </div>
</div>
<!-- CANCEL -->
<div class="modal fade" id="cancelModal" tabindex="-1">
  <div class="modal-dialog modal-sm">
    <form id="cancelForm" class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Cancel Appointment</h5>
        <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body text-center">
        <input type="hidden" name="appt_id" id="cancelApptId">
        <p>Are you sure you want to cancel?</p>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-danger">Yes, Cancel</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
      </div>
    </form>
  </div>
</div>
<!-- APPOINTMENT DETAILS MODAL -->
<div class="modal fade" id="appointmentDetailsModal" tabindex="-1">
  <div class="modal-dialog modal-md">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">üìã Appointment Details</h5>
        <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <p><strong>Patient Name:</strong> <span id="detailFullname"></span></p>
            <p><strong>Date:</strong> <span id="detailDate"></span></p>
            <p><strong>Time:</strong> <span id="detailTime"></span></p>
            <p><strong>Status:</strong> <span id="detailStatus"></span></p>
          </div>
          <div class="col-md-6">
            <p><strong>Service:</strong> <span id="detailService"></span></p>
            <p><strong>Down Payment:</strong> ‚Ç±<span id="detailDownpayment"></span></p>
            <p><strong>Payment Method:</strong> <span id="detailPaymentMethod"></span></p>
            <p><strong>Payment Status:</strong> <span id="detailPaymentStatus"></span></p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- ================= SCRIPTS ================= -->
<script src="https://cdn.jsdelivr.net/npm/jquery@2.2.4/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.4/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js"></script>


<!-- TABULATOR -->
<script src="https://unpkg.com/tabulator-tables@6.3.1/dist/js/tabulator.min.js"></script>
<!-- SweetAlert2 JS - ADD THIS LINE -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


<script>
    // Toast notification helpers
function showToastSuccess(title) {
    Swal.fire({ 
        icon: 'success', 
        title: title, 
        toast: true, 
        position: 'top-end', 
        showConfirmButton: false, 
        timer: 1500 
    });
}

function showToastError(title) {
    Swal.fire({ 
        icon: 'error', 
        title: title, 
        toast: true, 
        position: 'top-end', 
        showConfirmButton: false, 
        timer: 1800 
    });
}
// DATA
const appointmentsData = [
{% for appt in appointments %}
{
    id: "{{ appt._id }}",
    fullname: "{{ appt.fullname }}",
    date: "{{ appt.date }}",
    time: "{{ appt.time | to_ampm }}",
    time24: "{{ appt.time_24 if appt.time_24 else appt.time }}",
    status: "{% if appt.status and appt.status.lower() == 'done' %}Done{% elif appt.status and appt.status.lower() == 'cancelled' %}Cancelled{% elif appt.date == current_date %}Waiting{% elif appt.date < current_date %}Done{% else %}Upcoming{% endif %}",
    is_today: {{ 'true' if appt.date == current_date else 'false' }},
    sort_rank: {{ 2 if (appt.status and appt.status.lower() in ['done','cancelled']) or (appt.date < current_date) else 1 }},
    datetime: new Date("{{ appt.date }}T{{ appt.time_24 if appt.time_24 else appt.time }}"),
    services_display: "{% for s in appt.services %}{{ s.name }}{% if not loop.last %}, {% endif %}{% endfor %}",
    service_full: "{{ appt.service | default('N/A') }}",
    downpayment: "{{ appt.downpayment | default(0) }}",
    payment_method: "{{ appt.payment_method | default('N/A') }}",
    payment_status: "{{ appt.payment_status | default('pending') }}",
    payment_proof: "{{ appt.payment_proof | default('') }}"
},
{% endfor %}
];

// SHOW APPOINTMENT DETAILS FUNCTION
function showAppointmentDetails(data) {
    $("#detailFullname").text(data.fullname);
    $("#detailDate").text(data.date);
    $("#detailTime").text(data.time);
    
    // Status with badge
    let badge = "secondary";
    if (data.status === "Waiting") badge = "warning";
    else if (data.status === "Done") badge = "success";
    else if (data.status === "Upcoming") badge = "info";
    else if (data.status === "Cancelled") badge = "danger";
    $("#detailStatus").html('<span class="badge badge-' + badge + '">' + data.status + '</span>');
    
    $("#detailService").text(data.service_full);
    $("#detailDownpayment").text(parseFloat(data.downpayment).toLocaleString());
    $("#detailPaymentMethod").text(data.payment_method.toUpperCase());
    
    // Payment status with badge
    const paymentBadge = data.payment_status === "approved" ? "success" : "warning";
    $("#detailPaymentStatus").html('<span class="badge badge-' + paymentBadge + '">' + data.payment_status.toUpperCase() + '</span>');
    
    // Payment proof image
    if (data.payment_proof && data.payment_proof !== '') {
        $("#detailPaymentProofImg").attr("src", data.payment_proof);
        $("#detailPaymentProof").show();
    } else {
        $("#detailPaymentProof").hide();
    }
    
    $("#appointmentDetailsModal").modal("show");
}

// TABULATOR TABLE
const table = new Tabulator("#appointments-table", {
    data: appointmentsData,
    layout: "fitDataStretch",
    responsiveLayout: "collapse",
    pagination: "local",
    paginationSize: 10,
    placeholder: "<i class='fa fa-calendar-o'></i><br><strong>No appointments found</strong><br>There are currently no appointment records to display.",

    initialSort: [
        { column: "sort_rank", dir: "asc" },
        { column: "datetime", dir: "asc" }
    ],

    columns: [
        { title: "Patient Name", field: "fullname", headerFilter: "input", widthGrow: 2 },
        { title: "Date", field: "date", sorter: "date", widthGrow: 1.5 },
        { title: "Time", field: "time", sorter: "string", widthGrow: 1 },
        { 
            title: "Service(s)", 
            field: "services_display", 
            headerFilter: "input",
            widthGrow: 2,
            formatter: function(cell) {
                const fullText = cell.getValue();
                const shortText = fullText.length > 30 ? fullText.substring(0, 30) + '...' : fullText;
                return '<span style="cursor: pointer;">' + shortText + '</span>';
            }
        },
        { 
            title: "Status", 
            field: "status",
            widthGrow: 1,
            formatter: function(cell){
                const s = cell.getValue();
                let badge = "secondary";
                if (s === "Waiting") badge = "warning";
                else if (s === "Done") badge = "success";
                else if (s === "Upcoming") badge = "info";
                else if (s === "Cancelled") badge = "danger";
                return '<span class="badge badge-' + badge + '">' + s + '</span>';
            }
        },
        { 
            title: "Actions",
            hozAlign: "center",
            minWidth: 200, // ADJUST: Minimum width for actions column (try: 180, 200, 220)
            widthGrow: 2.5, // ADJUST: Growth priority (try: 2, 2.5, 3)
            formatter: function(cell){
                const r = cell.getRow().getData();

                if (r.status === "Done" || r.status === "Cancelled") {
                    return '<span class="text-muted">‚Äî</span>';
                }

                let buttons = '<div class="action-buttons">';
                buttons += '<button class="btn btn-sm btn-warning btn-action btn-reschedule" data-id="' + r.id + '" data-date="' + r.date + '" data-time="' + r.time24 + '" title="Reschedule">üîÅ</button>';
                buttons += '<button class="btn btn-sm btn-danger btn-action btn-cancel" data-id="' + r.id + '" title="Cancel">‚ùå</button>';

                if (r.is_today && r.status === "Waiting") {
                    buttons += '<button class="btn btn-sm btn-success btn-action" onclick="markDone(\'' + r.id + '\'); event.stopPropagation();" title="Mark as Done">‚úî</button>';
                }
                buttons += '</div>';

                return buttons;
            }
        }
    ]
});

// Wait for table to be built, then attach row click event
table.on("tableBuilt", function(){
    table.on("rowClick", function(e, row){
        // Check if click is on a button or inside a button
        const isButton = e.target.tagName === 'BUTTON' || 
                        e.target.closest('button') !== null ||
                        e.target.classList.contains('btn') ||
                        e.target.closest('.btn') !== null;
        
        if (isButton) {
            return;
        }
        
        const data = row.getData();
        showAppointmentDetails(data);
    });
});

// Add CSS to show rows are clickable
const style = document.createElement('style');
style.textContent = '.tabulator-row { cursor: pointer; } .tabulator-row:hover { background-color: #f0f8ff !important; }';
document.head.appendChild(style);

// MARK DONE function
function markDone(appointmentId) {
    Swal.fire({
        title: 'Mark as Done?',
        text: "Confirm that this appointment is completed",
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#28a745',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Yes, mark as done!',
        cancelButtonText: 'Cancel'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch("/api/appointments/mark-done", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ appointment_id: appointmentId })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToastSuccess('Appointment marked as done');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToastError(data.error || 'Failed to update');
                }
            })
            .catch(() => {
                showToastError('Server error');
            });
        }
    });
}

// RESCHEDULE / CANCEL buttons
$(document).on("click", ".btn-reschedule", function (e) {
    e.stopPropagation();
    $("#rescheduleApptId").val($(this).data("id"));
    $("#rescheduleDate").val($(this).data("date"));
    $("#rescheduleTime").val($(this).data("time"));
    $("#rescheduleModal").modal("show");
});

$(document).on("click", ".btn-cancel", function (e) {
    e.stopPropagation();
    $("#cancelApptId").val($(this).data("id"));
    $("#cancelModal").modal("show");
});

// RESCHEDULE FORM HANDLER
$("#rescheduleForm").on("submit", function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    $.ajax({
        url: "{{ url_for('reschedule_appointment_post') }}",
        method: "POST",
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            $("#rescheduleModal").modal("hide");
            
            if (response.success) {
                showToastSuccess('Appointment rescheduled');
                setTimeout(() => location.reload(), 1500);
            } else {
                showToastError(response.error || 'Failed to reschedule');
            }
        },
        error: function(xhr) {
            $("#rescheduleModal").modal("hide");
            showToastError('Server error');
        }
    });
});


// CANCEL FORM HANDLER
$("#cancelForm").on("submit", function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    $.ajax({
        url: "{{ url_for('cancel_appointment_post') }}",
        method: "POST",
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            $("#cancelModal").modal("hide");
            
            if (response.success) {
                showToastSuccess('Appointment cancelled');
                setTimeout(() => location.reload(), 1500);
            } else {
                showToastError(response.error || 'Failed to cancel');
            }
        },
        error: function(xhr) {
            $("#cancelModal").modal("hide");
            showToastError('Server error');
        }
    });
});

// Clean up modal backdrop
$('#rescheduleModal, #cancelModal, #appointmentDetailsModal').on('hidden.bs.modal', function() {
    $('body').removeClass('modal-open');
    $('.modal-backdrop').remove();
});
</script>






<script>
console.log("jQuery loaded:", typeof $ !== 'undefined');
console.log("Bootstrap loaded:", typeof $.fn.modal !== 'undefined');

// Test if modal exists
console.log("Modal exists:", $("#appointmentDetailsModal").length > 0);
</script>
</body>
</html>
